<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Perfect Match</title>

<!-- MATCH DAILY FORECAST STYLE -->
<link rel="stylesheet" href="style.css">

<!-- Astronomy Engine (free GitHub-based library) -->
<script src="https://cdn.jsdelivr.net/npm/astronomy-engine@2.1.0/astronomy.min.js"></script>

<meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body>

<div class="tool-container">

  <img src="logo.png" class="logo" alt="Logo">

  <h1>Perfect Match</h1>

  <p class="warning">
    ⚠️ Birth time must be entered in UTC/GMT.<br>
    ⚠️ Only one submission per person per day. Double-check details before submitting.
  </p>

  <label>Email</label>
  <input id="email" type="email" required>

  <label>Gender</label>
  <select id="gender">
    <option value="male">Male</option>
    <option value="female">Female</option>
  </select>

  <label>Date of Birth</label>
  <input id="dob" type="date">

  <label>Time of Birth (UTC)</label>
  <input id="tob" type="time">

  <button onclick="runMatch()">Search</button>

  <div id="result"></div>

</div>

<script>
async function runMatch() {

  const result = document.getElementById("result");
  result.innerText = "Searching…";

  try {

    const email = document.getElementById("email").value.trim();
    const gender = document.getElementById("gender").value;
    const dob = document.getElementById("dob").value;
    const tob = document.getElementById("tob").value;

    if (!email || !dob || !tob) {
      result.innerText = "Please fill all fields.";
      return;
    }

    const today = new Date().toISOString().slice(0,10);
    if (localStorage.getItem(email) === today) {
      result.innerText = "Only one submission per person per day is allowed.";
      return;
    }

    if (typeof Astronomy === "undefined") {
      result.innerText = "Astrology engine failed to load. Refresh the page.";
      return;
    }

    const birthUTC = new Date(`${dob}T${tob}:00Z`);

    const sun   = Astronomy.EclipticLongitude(Astronomy.Body.Sun, birthUTC);
    const moon  = Astronomy.EclipticLongitude(Astronomy.Body.Moon, birthUTC);
    const venus = Astronomy.EclipticLongitude(Astronomy.Body.Venus, birthUTC);

    const response = await fetch("ephemeris_3hour_1940_2030.csv");
    if (!response.ok) {
      result.innerText = "Ephemeris file not found.";
      return;
    }

    const text = await response.text();
    const rows = text.split("\n").slice(1);

    const ORB = 8;
    const matches = new Set();

    function diff(a,b){
      let d=Math.abs(a-b);
      return d>180?360-d:d;
    }

    function hit(a,b){
      const d=diff(a,b);
      return d<=ORB || Math.abs(d-120)<=ORB;
    }

    for (const r of rows) {
      const p=r.split(",");
      if (p.length<4) continue;

      const date=p[0].split(" ")[0];
      const s=parseFloat(p[1]);
      const m=parseFloat(p[2]);
      const v=parseFloat(p[3]);

      if (gender==="male" && (hit(s,venus)||hit(v,s))) matches.add(date);
      if (gender==="female" && (hit(m,venus)||hit(v,m))) matches.add(date);
    }

    localStorage.setItem(email,today);

    if (!matches.size) {
      result.innerText="No perfect matches found in the current date range.";
      return;
    }

    result.innerHTML =
      "<b>Perfect Matches:</b><br><br>" +
      [...matches].slice(0,300).join("<br>") +
      "<br><br>You will be notified if anyone with these birth dates is added.";

  } catch(e) {
    console.error(e);
    result.innerText="Unexpected error. Refresh and try again.";
  }
}
</script>

</body>
</html>
