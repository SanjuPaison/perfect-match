<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Perfect Match</title>

<style>
body {
  background:#000;
  color:#fff;
  font-family: Arial, sans-serif;
  display:flex;
  justify-content:center;
}
.container {
  width:100%;
  max-width:420px;
  padding:20px;
}
h1 {
  text-align:center;
  margin-bottom:10px;
}
.warning {
  font-size:12px;
  color:#ffcc00;
  text-align:center;
  margin-bottom:15px;
}
input, select, button {
  width:100%;
  padding:10px;
  margin:6px 0;
  border-radius:4px;
  border:none;
  font-size:14px;
}
button {
  background:#fff;
  color:#000;
  font-weight:bold;
  cursor:pointer;
}
#status {
  text-align:center;
  margin-top:10px;
}
#results {
  margin-top:15px;
  font-size:14px;
  line-height:1.6;
}
</style>
</head>

<body>
<div class="container">
<h1>Perfect Match</h1>

<div class="warning">
⚠ Use UTC/GMT time.<br>
⚠ Only one submission per email per day.<br>
⚠ Double-check details before submitting.
</div>

<select id="gender">
  <option value="">Gender</option>
  <option value="male">Male</option>
  <option value="female">Female</option>
</select>

<input type="date" id="dob">
<input type="time" id="tob">
<input type="email" id="email" placeholder="Email">

<button onclick="search()">Find Matches</button>

<div id="status"></div>
<div id="results"></div>
</div>

<script>
const CSV_FILE = "ephemeris_3hour_1940_2030.csv";
const ORB = 8;

let ephemeris = [];

fetch(CSV_FILE)
.then(r => r.text())
.then(t => {
  const lines = t.trim().split("\n");
  ephemeris = lines.slice(1).map(l => {
    const [dt,sun,moon,venus] = l.split(",");
    return {
      dt,
      sun: parseFloat(sun),
      moon: parseFloat(moon),
      venus: parseFloat(venus)
    };
  });
});

function normalize(a){
  a%=360;
  return a<0?a+360:a;
}
function inRange(a,b){
  let d = Math.abs(a-b);
  return d<=ORB || Math.abs(d-360)<=ORB;
}

function search(){
  const gender = document.getElementById("gender").value;
  const dob = document.getElementById("dob").value;
  const tob = document.getElementById("tob").value;
  const email = document.getElementById("email").value.trim().toLowerCase();

  if(!gender||!dob||!tob||!email){
    alert("Fill all fields");
    return;
  }

  const today = new Date().toISOString().slice(0,10);
  const key = email+"_"+today;
  if(localStorage.getItem(key)){
    alert("Only one submission per email per day.");
    return;
  }
  localStorage.setItem(key,"1");

  document.getElementById("status").innerText="Searching…";
  document.getElementById("results").innerHTML="";

  /* snap to 3-hour UTC */
  const h = parseInt(tob.slice(0,2),10);
  const snap = Math.round(h/3)*3 % 24;
  const birthKey = dob+" "+String(snap).padStart(2,"0");

  const birthRow = ephemeris.find(r=>r.dt.startsWith(birthKey));
  if(!birthRow){
    document.getElementById("status").innerText="Birth time not found in ephemeris range.";
    return;
  }

  const uSun=birthRow.sun;
  const uMoon=birthRow.moon;
  const uVenus=birthRow.venus;

  /* PRE-CALCULATE RANGES ONCE */
  let stage1, stage2;

  if(gender==="male"){
    stage1 = ephemeris.filter(r => inRange(r.venus, uSun));
    stage2 = stage1.filter(r => inRange(r.moon, uVenus));
  } else {
    stage1 = ephemeris.filter(r => inRange(r.sun, uVenus));
    stage2 = stage1.filter(r => inRange(r.venus, uMoon));
  }

  const dates = [...new Set(stage2.map(r=>r.dt.split(" ")[0]))];

  if(!dates.length){
    document.getElementById("status").innerText="No perfect matches found.";
    return;
  }

  document.getElementById("status").innerText="Perfect matches found:";
  document.getElementById("results").innerHTML =
    dates.slice(0,200).join("<br>");
}
</script>
</body>
</html>
